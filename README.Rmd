---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# bbousims

<!-- badges: start -->
<!-- badges: end -->

`bbousims` contains some general functionality for simulating population change of life stages over time from survival, ageing and birth processes. 

In addition, there are more user-friendly functions for simulating Boreal Caribou population change, recruitment data from hypothetical composition surveys and survival data from hypothetical collaring. 

## Installation

You can install the development version of bbousims from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("poissonconsulting/bbousims")
```



## General tools for simulating populations from BAS model

### Survival and fecundity rates

`bbs_survival()` and `bbs_fecundity()` can be used to stochastically generate survival and fecundity rates over time. 
Survival varies by period (e.g., month, season) with options to set the intercept, year trend, annual random effect, period random effect and period within annual random effect for each stage, on the log-odds scale. 

```{r}
survival <- bbs_survival(intercept = logit(c(0.94, 0.98, 0.98)),
                         trend = c(0, 0, 0.3),
                         annual_sd = rep(0.05, 3),
                         period_sd = rep(0.1, 3),
                         nyear = 4, 
                         nperiod_within_year = 4)
survival
```

Fecundity varies by year, with options to set the intercept, year trend and annual random effect for each stage, on the log-odds scale. Setting intercept to NA will force all rates in that stage to be 0. 

```{r}
fecundity <- bbs_fecundity(intercept = c(NA, NA, logit(0.4)),
                           trend = c(0, 0, -0.2),
                           annual_sd = c(0, 0, 0.1),
                           nyear = 4)
fecundity
```
### Process matrices
Survival and fecundity rate arrays can be converted into process matrices for use in BAS population projection. 
In this example we have three stages which could represent female calf, female yearling, and female adult.  
We can set the male recruit stage to be NULL to indicate that there is only one recruit stage. 
Otherwise, 

```{r}
survival_mat <- bbs_matrix_survival_period(survival)
birth_mat <- bbs_matrix_birth_year(fecundity, female_recruit_stage = 1, male_recruit_stage = NULL)
survival_mat
birth_mat
```

We can also generate an age process matrix, which does not vary in time. 
The input vector denotes which stage that stage will age into (i.e., stage 1 ages to stage 2, stage 2 ages into stage 3 and stage 3 collects).

```{r}
age_mat <- bbs_matrix_age(c(2, 3, 3))
```

### Simulate population projection
`bbousims` contains a custom infix operator `%*b%` to perform matrix multiplication with stochasticity. Instead of multiplying the population at each stage by the corresponding rate, `%*b%` draws from a binomial distribution, where size is the population and probability is the rate of interest.  

For example, with population vector and survival process matrix for the first period of the first year
```{r}
pop0 <- c(105, 81, 220)
survival_mat1 <- survival_mat[,,1,1]
```

regular (deterministic) matrix multiplication yields

```{r}
survival_mat1 %*% pop0
```

and stochastic matrix multiplication yields 

```{r}
survival_mat1 %*b% pop0
```

We can use the survival, age and birth process matrices to project population forward in time based on the time-varying rates generated previously. 

```{r}
population <- bbs_population(pop0, 
                                 birth = birth_mat, 
                                 age = age_mat, 
                                 survival = survival_mat)
```

## Boreal Caribou population projection
More user-friendly functionality exists for simulating Boreal Caribou population, where it is assumed that there are six stages: female calf, male calf, female yearling, male yearling, female adult and male adult. 
The survival/fecundity rates are generated for the female stages and population is first projected for those stages. 
Male stage abundances are 'filled in' based on provided sex ratios. 
The initial population vector is determined by calculating stable stage distribution. 
See output of `bbs_demographic_summary()` for methods and other useful calculations such as estimated lambda. 


```{r}
set.seed(1)
population <- bbs_population_caribou(nyear = 50, 
                                     survival_adult_female = 0.85,
                                     survival_calf_female = 0.5,
                                     calves_per_adult_female = 0.7)
bbs_plot_population(population)
```
Adding a negative trend and high standard deviation of the annual random effect in the adult female survival will cause higher variation and downward projection of population.s

```{r}
set.seed(1)
population <- bbs_population_caribou(nyear = 50, 
                                     survival_adult_female = 0.85,
                                     survival_calf_female = 0.5,
                                     calves_per_adult_female = 0.7, 
                                     survival_trend_adult_female = -0.01,
                                     survival_annual_sd_adult_female = 0.5)
bbs_plot_population(population)
```

## Simulate Boreal Caribou survival and recruitment data

### Get demographic summary from key parameters


### Generate survival and fecundity rates




Assuming three stages (female calf, female yearling, female adult), survival can vary for adult females and calf females by intercept, trend, annual random effect, month random effect, and month within annual random effect for each. 
Survival of yearling females are determined as an effect on adult female survival. 
The intercept (survival_adult_female and survival_calf_female) is provided as an annual rate whereas the effects (trend, random effects, yearling effect) are provided on the log-odds scale, acting on the log-odds monthly survival rate (e.g., $logit(survival\_adult\_female) = logit(intercept^{(1/12)}) + trend \cdot year$).

```{r}
survival <- bbs_survival(
  survival_adult_female = 0.84, # annual
  survival_calf_female = 0.5, # annual
  yearling_effect = 0.1, # effects on log-odds scale
  annual_sd_adult_female = 0.1,
  month_sd_adult_female = 0.2,
  trend_adult_female = 0.1,
  trend_calf_female = -0.1,
  nyear = 4
)
```

Fecundity rates can vary for adult females by trend and annual random effect. As in survival, the trend and annual_sd are on the log-odds scale (e.g., $logit(fecundity\_adult\_female) = logit(intercept) + trend \cdot year$)
```{r}
fecundity <- bbs_fecundity(
  calves_per_adult_female = 0.4, trend = 0.05, annual_sd = 0.05, nyear = 4
)
```

These can be converted to process matrices for each year/month with `bbs_matrix_survival_period()` and `bbs_matrix_birth_year()`. 

```{r}
# first year
fecundity_process <- bbs_matrix_birth_year(fecundity)
fecundity_process[,,1]
# first period
survival_process <- bbs_matrix_survival_period(survival)
survival_process[,,1,1]
```

We can also create an ageing matrix with `bbs_matrix_age()`, where the default is for each stage to age into the next, with the final (third) stage as a collector. This does not vary with time. 
```{r}
bbs_matrix_age()
```

### Process matrix multiplication with demographic stochasticity


```{r}
pop <- c(105, 81, 220)
survival_mat <- survival_process[,,1,1]
```

regular (deterministic) matrix multiplication yields

```{r}
survival_mat %*% pop
```
and stochastic matrix multiplication yields 

```{r}
survival_mat %*b% pop
```

where the resulting population is composed of whole individuals and each iteration is different.  

### Simulate population projection from BAS model

### Simulate observed composition groups

## Doing more with `bbousims`
`bbousims` contains more flexible functionality to work with any stage composition.
For example, given the following stage composition